#!/bin/bash

# --- –ù–ê–°–¢–†–ê–ò–í–ê–ï–ú–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
# –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–û –°–í–û–ò–ú–ò –î–ê–ù–ù–´–ú–ò:
DOMAIN_NAME="–≤–∞—à_–¥–æ–º–µ–Ω.ru" # –ù–∞–ø—Ä–∏–º–µ—Ä: example.com
SITE_NAME="my_php_website" # –ò–º—è —Å–∞–π—Ç–∞ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∏–Ω—Å—Ç–∞–ª–ª–µ—Ä–∞
WP_DB_USER="webuser"       # –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–î WordPress (–µ—Å–ª–∏ –≤—ã –µ–≥–æ —Å–æ–∑–¥–∞–≤–∞–ª–∏)
WP_DB_NAME="website_db"    # –ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö WordPress
# --------------------------------

echo "========================================================="
echo "üõ†Ô∏è –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π –∏ SSL"
echo "üåê –î–æ–º–µ–Ω: $DOMAIN_NAME"
echo "========================================================="

# --- 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Certbot (Let's Encrypt) ---
echo "‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Certbot –∏ –ø–ª–∞–≥–∏–Ω–∞ –¥–ª—è Nginx..."
sudo apt update
sudo apt install -y certbot python3-certbot-nginx

# --- 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ SSL ---
echo "üîí –ó–∞–ø—É—Å–∫ Certbot –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞..."
# Certbot –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç Nginx –¥–ª—è HTTPS –∏ –¥–æ–±–∞–≤–∏—Ç –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ HTTP->HTTPS.
sudo certbot --nginx -d $DOMAIN_NAME -d www.$DOMAIN_NAME

if [ $? -eq 0 ]; then
    echo "‚úÖ SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω Nginx!"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –¥–æ–º–µ–Ω ($DOMAIN_NAME) —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ IP-–∞–¥—Ä–µ—Å —ç—Ç–æ–π VPS."
fi

# --- 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Nginx (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π) ---
echo "‚ôªÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫..."
sudo nginx -t
sudo systemctl reload nginx

# --- 4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö WordPress (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ---
# –ï—Å–ª–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±—ã–ª–∏ –≤—ã–∑–≤–∞–Ω—ã –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ URL –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
echo "---"
read -p "‚ùì –í—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ WordPress? (y/n): " IS_WORDPRESS

if [[ "$IS_WORDPRESS" =~ ^[Yy]$ ]]; then
    echo "‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è $WP_DB_USER –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö $WP_DB_NAME."
    echo "üîÑ –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–º–µ–Ω–∏—Ç—å URL –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ HTTPS..."
    
    # –ú—ã –º–µ–Ω—è–µ–º URL –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö WordPress —Å HTTP –Ω–∞ HTTPS,
    # —Ç–∞–∫ –∫–∞–∫ —Ç–µ–ø–µ—Ä—å Nginx –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ HTTPS.
    
    # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å SQL-–∫–æ–º–∞–Ω–¥–∞–º–∏
    SQL_FILE=$(mktemp)
    
    cat <<EOF > "$SQL_FILE"
    USE $WP_DB_NAME;
    UPDATE wp_options SET option_value = REPLACE(option_value, 'http://$DOMAIN_NAME', 'https://$DOMAIN_NAME') WHERE option_name IN ('home', 'siteurl');
    FLUSH PRIVILEGES;
EOF

    # –í—ã–ø–æ–ª–Ω—è–µ–º SQL-–∫–æ–º–∞–Ω–¥—ã
    mysql -u $WP_DB_USER -p < "$SQL_FILE"
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö WordPress —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ HTTPS."
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ MySQL. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ª–æ–≥–∏–Ω ($WP_DB_USER) –∏ –ø–∞—Ä–æ–ª—å –≤–µ—Ä–Ω—ã. –í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–∏–¥–µ—Ç—Å—è –≤–Ω–µ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—Ä—É—á–Ω—É—é."
    fi
    
    # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    rm "$SQL_FILE"
else
    echo "‚è© –ü—Ä–æ–ø—É—Å–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –Ω–µ WordPress."
fi

echo "========================================================="
echo "üéâ –§–ò–ö–° –ó–ê–í–ï–†–®–ï–ù"
echo "–¢–µ–ø–µ—Ä—å –≤–∞—à —Å–∞–π—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ https://$DOMAIN_NAME"
echo "========================================================="
