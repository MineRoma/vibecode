#!/bin/bash

# --- –ù–ê–°–¢–†–ê–ò–í–ê–ï–ú–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ò–ó–ú–ï–ù–ò–¢–¨) ---
DOMAIN_NAME="mineroma.work.gd"
SITE_NAME="my_php_website"
IP_ADDRESS="62.60.187.58" # –í–∞—à IP-–∞–¥—Ä–µ—Å
# -----------------------------------------------------

WEB_ROOT="/var/www/html/$SITE_NAME"
PHP_VERSION="8.1"
NGINX_CONF="/etc/nginx/sites-available/$SITE_NAME"

# --- –§—É–Ω–∫—Ü–∏—è: –û–∂–∏–¥–∞–Ω–∏–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ APT ---
function wait_for_lock() {
    echo "‚åõ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–∂–∏–¥–∞–Ω–∏–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ APT/DPKG..."
    LOCK_FILES=("/var/lib/dpkg/lock-frontend" "/var/lib/dpkg/lock" "/var/cache/apt/archives/lock")
    for lock in "${LOCK_FILES[@]}"; do
        i=0
        while fuser "$lock" >/dev/null 2>&1; do
            i=$((i+1))
            if [ $i -gt 15 ]; then # –¢–∞–π–º–∞—É—Ç 2.5 –º–∏–Ω—É—Ç—ã
                echo "‚ö†Ô∏è –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ ($lock) —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ. –ü–æ–ø—Ä–æ–±—É–µ–º —É–±–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å..."
                PID=$(fuser -k -s $lock)
                sudo kill -9 "$PID" 2>/dev/null
                sleep 5
            fi
            echo "   ... –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ $lock. –û–∂–∏–¥–∞–µ–º 10 —Å–µ–∫—É–Ω–¥..."
            sleep 10
        done
    done
    echo "‚úÖ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º."
}

# --- 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ UFW (–§–∞–π—Ä–≤–æ–ª) ---
echo "---"
echo "üõ†Ô∏è –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ UFW (–§–∞–π—Ä–≤–æ–ª)..."
wait_for_lock

if ! command -v ufw &> /dev/null
then
    echo "   -> UFW –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º UFW."
    sudo apt install ufw -y
else
    echo "   -> UFW —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
fi

# –û—Ç–∫—Ä—ã—Ç–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–æ—Ä—Ç–æ–≤ –∏ –∞–∫—Ç–∏–≤–∞—Ü–∏—è UFW
sudo ufw allow ssh
sudo ufw allow "Nginx Full"
if [ "$(sudo ufw status | grep -c "Status: active")" -eq 0 ]; then
    echo "   -> –ê–∫—Ç–∏–≤–∞—Ü–∏—è UFW. –ù–∞–∂–º–∏—Ç–µ 'y', –µ—Å–ª–∏ –ø–æ–ø—Ä–æ—Å—è—Ç."
    sudo ufw enable
fi
echo "‚úÖ UFW –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü–æ—Ä—Ç—ã 80, 443, 22 –æ—Ç–∫—Ä—ã—Ç—ã –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º —É—Ä–æ–≤–Ω–µ."

# --- 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx (–£–¥–∞–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ fastcgi_param) ---
echo "---"
echo "üõ†Ô∏è –®–∞–≥ 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫..."

# 2.1. –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
sudo rm -f /etc/nginx/sites-enabled/$SITE_NAME

# 2.2. –°–æ–∑–¥–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª
sudo bash -c "cat <<EOF > $NGINX_CONF
server {
    listen 80;
    server_name $DOMAIN_NAME www.$DOMAIN_NAME $IP_ADDRESS; # –î–æ–±–∞–≤–ª—è–µ–º IP –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã

    root $WEB_ROOT;
    index index.php index.html index.htm;

    # –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô try_files –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã PHP –∏ Certbot
    location / {
        try_files \$uri \$uri/ =404;
    }

    # Pass PHP scripts to FPM
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php${PHP_VERSION}-fpm.sock;
    }
}
EOF"

# 2.3. –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ñ–∏–≥
sudo ln -s $NGINX_CONF /etc/nginx/sites-enabled/

# 2.4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ Nginx
sudo nginx -t
if [ $? -eq 0 ]; then
    sudo systemctl restart nginx
    echo "‚úÖ Nginx –∑–∞–ø—É—â–µ–Ω —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π."
else
    echo "‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê NGINX: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–ª–æ–º–∞–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ $NGINX_CONF –≤—Ä—É—á–Ω—É—é!"
fi

# --- 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫ Certbot (SSL/HTTPS) ---
echo "---"
echo "üõ†Ô∏è –®–∞–≥ 3: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫ Certbot –¥–ª—è HTTPS..."
wait_for_lock

if ! command -v certbot &> /dev/null
then
    echo "   -> Certbot –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Certbot."
    sudo apt install certbot python3-certbot-nginx -y
else
    echo "   -> Certbot —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
fi

echo "   -> –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞. –≠—Ç–æ —Ç–∞–∫–∂–µ –∏—Å–ø—Ä–∞–≤–∏—Ç —Ü–∏–∫–ª—ã –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏–∏ HTTP->HTTPS."
sudo certbot --nginx -d $DOMAIN_NAME -d www.$DOMAIN_NAME

if [ $? -eq 0 ]; then
    echo "‚úÖ SSL —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –°–∞–π—Ç —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ HTTPS."
else
    echo "‚ùå –û–®–ò–ë–ö–ê CERTBOT: –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–µ –ø–æ–ª—É—á–µ–Ω. –ü—Ä–∏—á–∏–Ω–∞ 99%: –ü–æ—Ä—Ç 80/443 –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –≤–Ω–µ—à–Ω–∏–º —Ñ–∞–π—Ä–≤–æ–ª–æ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞!"
fi

# --- 4. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ—Å–ª–µ —Ñ–∏–∫—Å–∞ ---
echo "---"
echo "üéâ –§–ò–ö–°–ï–† –ó–ê–í–ï–†–®–ò–õ –†–ê–ë–û–¢–£!"
echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à IP-–∞–¥—Ä–µ—Å ($IP_ADDRESS) –ø–æ HTTP. –û–Ω –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å."
echo "2. –ï—Å–ª–∏ —Å–∞–π—Ç –≤—Å–µ –µ—â–µ –≤—ã–¥–∞–µ—Ç —Ü–∏–∫–ª –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏–∏, **–û–ë–ù–û–í–ò–¢–ï URL –í –ë–ê–ó–ï –î–ê–ù–ù–´–•** (—Å–º. –Ω–∏–∂–µ)."
echo "3. –ï—Å–ª–∏ Certbot –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, **–û–¢–ö–†–û–ô–¢–ï –ü–û–†–¢ 80** –≤ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∞—à–µ–≥–æ VPS-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞."

echo "--------------------------------------------------------"
echo "üì¢ –ï—Å–ª–∏ —Å–∞–π—Ç ‚Äì WordPress –∏ –≤—ã–¥–∞–µ—Ç —Ü–∏–∫–ª –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏–∏:"
echo "   –í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–∏ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞ HTTPS (–∏–ª–∏ –Ω–∞ HTTP, –µ—Å–ª–∏ SSL –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª):"
echo "   sudo mysql -u root -p"
echo "   USE website_db; # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –∏–º—è –≤–∞—à–µ–π –ë–î"
echo "   # –ú–µ–Ω—è–µ–º –Ω–∞ HTTPS, –µ—Å–ª–∏ Certbot —Å—Ä–∞–±–æ—Ç–∞–ª:"
echo "   # UPDATE wp_options SET option_value = REPLACE(option_value, 'http://$DOMAIN_NAME', 'https://$DOMAIN_NAME') WHERE option_name IN ('home', 'siteurl');"
echo "   # –ú–µ–Ω—è–µ–º –Ω–∞ HTTP, –µ—Å–ª–∏ Certbot –ù–ï —Å—Ä–∞–±–æ—Ç–∞–ª:"
echo "   # UPDATE wp_options SET option_value = REPLACE(option_value, 'https://$DOMAIN_NAME', 'http://$DOMAIN_NAME') WHERE option_name IN ('home', 'siteurl');"
echo "   EXIT;"
echo "--------------------------------------------------------"
