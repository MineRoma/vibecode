#!/bin/bash

# --- –ù–ê–°–¢–†–ê–ò–í–ê–ï–ú–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ò–ó–ú–ï–ù–ò–¢–¨) ---
DOMAIN_NAME="mineroma.work.gd"
SITE_NAME="my_php_website"
IP_ADDRESS="62.60.187.58" # –í–∞—à IP-–∞–¥—Ä–µ—Å
# -----------------------------------------------------

WEB_ROOT="/var/www/html/$SITE_NAME"
PHP_VERSION="8.1"
NGINX_CONF="/etc/nginx/sites-available/$SITE_NAME"

# --- –§—É–Ω–∫—Ü–∏—è: –û–∂–∏–¥–∞–Ω–∏–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ APT ---
function wait_for_lock() {
    echo "‚åõ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–∂–∏–¥–∞–Ω–∏–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ APT/DPKG..."
    LOCK_FILES=("/var/lib/dpkg/lock-frontend" "/var/lib/dpkg/lock" "/var/cache/apt/archives/lock")
    for lock in "${LOCK_FILES[@]}"; do
        while fuser "$lock" >/dev/null 2>&1; do
            sleep 5
        done
    done
    echo "‚úÖ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º."
}

# --- 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Nginx –∏ UFW (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π) ---
echo "---"
echo "üõ†Ô∏è –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤..."
wait_for_lock
sudo apt install -y nginx ufw

# --- 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫ Nginx ---
echo "---"
echo "üõ†Ô∏è –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ —á–∏—Å—Ç–æ–π –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx..."

# 2.1. –£–¥–∞–ª—è–µ–º —Å–ª–æ–º–∞–Ω–Ω—É—é —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫—É—é —Å—Å—ã–ª–∫—É
sudo rm -f /etc/nginx/sites-enabled/$SITE_NAME

# 2.2. –°–æ–∑–¥–∞–µ–º —á–∏—Å—Ç—ã–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª
sudo bash -c "cat <<EOF > $NGINX_CONF
server {
    listen 80;
    server_name $DOMAIN_NAME www.$DOMAIN_NAME $IP_ADDRESS; 

    root $WEB_ROOT;
    index index.php index.html index.htm;

    # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π try_files
    location / {
        try_files \$uri \$uri/ =404;
    }

    # Pass PHP scripts to FPM
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php${PHP_VERSION}-fpm.sock;
    }
}
EOF"

# 2.3. –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥
sudo ln -s $NGINX_CONF /etc/nginx/sites-enabled/

# 2.4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ Nginx
sudo nginx -t
if [ $? -eq 0 ]; then
    sudo systemctl restart nginx
    echo "‚úÖ Nginx –∑–∞–ø—É—â–µ–Ω —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π."
    
    # 2.5. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Nginx –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç—ã
    echo "üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤..."
    sudo ss -tuln | grep -E '80|443'
else
    echo "‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê NGINX: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–ª–æ–º–∞–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ $NGINX_CONF –≤—Ä—É—á–Ω—É—é!"
fi

echo "---"
echo "üéâ –§–ò–ö–° –ó–ê–í–ï–†–®–ï–ù."
echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ IP-–∞–¥—Ä–µ—Å: http://$IP_ADDRESS/"
echo "2. –ï—Å–ª–∏ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É ERR_CONNECTION_REFUSED, –∏—â–∏—Ç–µ 'Firewall Rules' –≤ –ø–∞–Ω–µ–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞."
